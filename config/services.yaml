# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    default_version: '1.0.0'
    app.document_storage_path: '%kernel.project_dir%/public/storage'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'

    Symfony\Component\Finder\Finder: ~

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones
    
    # ðŸ”§ Explicit controller registration for API Platform
    App\Controller\LlmController:
        public: true
        arguments:
            $bus: '@messenger.default_bus'
            $llmConnector: '@App\Service\Connector\LlmConnector'
            $tokenChunker: '@App\Service\TokenChunker'
            $logger: '@logger'
            $serializer: '@serializer'
            $queueStats: '@App\Service\QueueStatsService'
    App\Controller\ExtractionController:
        public: true
        arguments:
            $bus: '@messenger.default_bus'
            $queueStats: '@App\Service\QueueStatsService'
            $logger: '@logger'
            $serializer: '@serializer'

    App\Controller\IndexingController:
        public: true
        arguments:
            $bus: '@messenger.default_bus'
            $queueStats: '@App\Service\QueueStatsService'
            $logger: '@logger'
            $serializer: '@serializer'

    App\Controller\StatusController:
        autowire: true
        autoconfigure: true
        public: true

    Symfony\Component\Messenger\Transport\TransportInterface $asyncTransport:
        alias: 'messenger.transport.async'

    App\MessageHandler\:
        resource: '../src/MessageHandler'
        exclude: '../src/MessageHandler/ExtractorMessageHandler.php'
        tags: ['messenger.message_handler']
        
    App\MessageHandler\ExtractorMessageHandler:
        arguments:
            $logger: '@logger'
            $promptsPath: '%kernel.project_dir%/config/prompts/extraction.yaml'
            $documentStoragePath: '%app.document_storage_path%'
        tags: ['messenger.message_handler']
        
    App\MessageHandler\LlmMessageHandler:
        arguments:
            $outputPath: '%kernel.project_dir%/var/llm_output/'
            $queueStats: '@App\Service\QueueStatsService'
        tags: ['messenger.message_handler']
        
    App\MessageHandler\IndexingMessageHandler:
        arguments:
            $neo4jConnector: '@App\Service\Connector\Neo4JConnector'
            $queueStats: '@App\Service\QueueStatsService'
            $logger: '@logger'
        tags: ['messenger.message_handler']
        
    # Debug and Testing services
    App\Service\Connector\OllamaModelManager:
        arguments:
            $llmConnector: '@App\Service\Connector\LlmConnector'
            
    App\Controller\DebugController:
        public: true
        arguments:
            $llmConnector: '@App\Service\Connector\LlmConnector'
        
    App\Controller\LlmTestController:
        public: true
        
    # ðŸš€ Performance & Configuration Services
    App\Service\CacheManager:
        arguments:
            $cache: '@cache.app'
            
    App\Service\ConfigurationManager:
        arguments:
            $params: '@parameter_bag'
            
    App\Service\Factory\ConnectorFactory:
        arguments:
            $httpClient: '@App\Service\HttpClientService'
            $config: '@App\Service\ConfigurationManager'
            
    App\Service\OptimizedStatusService:
        arguments:
            $connectors:
                TikaConnector: '@App\Service\Connector\TikaConnector'
                Neo4jConnector: '@App\Service\Connector\Neo4JConnector' 
                LlmConnector: '@App\Service\Connector\LlmConnector'
            $cacheManager: '@App\Service\CacheManager'
            $logger: '@logger'
            
    App\Service\OptimizedPromptRenderer:
        arguments:
            $template: '' # Will be set dynamically
            $cacheManager: '@App\Service\CacheManager'
            
    # Admin Configuration Controllers
    App\Controller\AdminConfigStatusController:
        public: true
        arguments:
            $configManager: '@App\Service\ConfigurationManager'
            

    App\Controller\AdminConfigEnvController:
        public: true
            
    # Queue Statistics Service
    App\Service\QueueStatsService:
        arguments:
            $asyncTransport: '@messenger.transport.async'
            $logger: '@logger'
            
    # File Storage Service
    App\Service\FileStorageService:
        arguments:
            $documentStoragePath: '%app.document_storage_path%'
            $llmOutputPath: '%kernel.project_dir%/var/llm_output/'
            $logger: '@logger'
            
    # Admin File Storage Controller
    App\Controller\FileStorageController:
        public: true
        arguments:
            $fileStorageService: '@App\Service\FileStorageService'

    # Redis Connector Service for Message Queue Monitoring
    App\Service\Connector\RedisConnector:
        public: true

    # Queue Debug Controller
    App\Controller\DebugQueueController:
        public: true
        arguments:
            $queueStats: '@App\Service\QueueStatsService'
            $redisConnector: '@App\Service\Connector\RedisConnector'

    # ========================================================================
    # REQUIREMENTS EXTRACTION PIPELINE (IRREB + schema.org)
    # ========================================================================

    # TOON Formatter Service (Token-optimiertes Format)
    App\Service\ToonFormatterService: ~

    # Requirements Extraction Service
    App\Service\RequirementsExtractionService:
        arguments:
            $tikaConnector: '@App\Service\Connector\TikaConnector'
            $llmConnector: '@App\Service\Connector\LlmConnector'
            $neo4jConnector: '@App\Service\Connector\Neo4JConnector'
            $tokenChunker: '@App\Service\TokenChunker'
            $toonFormatter: '@App\Service\ToonFormatterService'
            $logger: '@logger'

    # Requirements Message Handler
    App\MessageHandler\RequirementsMessageHandler:
        arguments:
            $extractionService: '@App\Service\RequirementsExtractionService'
            $queueStats: '@App\Service\QueueStatsService'
            $logger: '@logger'
            $outputPath: '%kernel.project_dir%/var/requirements_output/'
        tags: ['messenger.message_handler']

    # Process Requirements Command
    App\Command\ProcessRequirementsCommand:
        arguments:
            $extractionService: '@App\Service\RequirementsExtractionService'
            $messageBus: '@messenger.default_bus'
        tags: ['console.command']
